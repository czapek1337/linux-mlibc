sources:
  - name: "tzdata"
    subdir: "build"
    url: "https://data.iana.org/time-zones/releases/tzdata2021e.tar.gz"
    format: "tar.gz"
    version: "2021e"

  - name: "autoconf-v2.69"
    subdir: "build"
    url: "https://ftp.gnu.org/gnu/autoconf/autoconf-2.69.tar.xz"
    format: "tar.xz"
    extract_path: "autoconf-2.69"
    version: "2.69"

  - name: "automake-v1.15"
    subdir: "build"
    git: "https://git.savannah.gnu.org/git/automake.git"
    tag: "v1.15.1"
    version: "1.15.1"
    regenerate:
      - args: ["./bootstrap"]

  - name: "libtool"
    subdir: "build"
    git: "https://git.savannah.gnu.org/git/libtool.git"
    tag: "v2.4.6"
    version: "2.4.6"
    tools_required: ["cross-automake-v1.15"]
    regenerate:
      - args: ["git", "submodule", "update", "--init"]
      - args: ["./bootstrap"]

  - name: "pkg-config"
    subdir: "build"
    git: "https://gitlab.freedesktop.org/pkg-config/pkg-config.git"
    tag: "pkg-config-0.29.2"
    version: "0.29.2"
    tools_required: ["cross-automake-v1.15", "cross-libtool"]
    regenerate:
      - args: ["./autogen.sh"]
        environ:
          NOCONFIGURE: "yes"

  - name: "binutils"
    subdir: "build"
    git: "https://github.com/bminor/binutils-gdb.git"
    tag: "binutils-2_38"
    version: "2.38"
    tools_required: ["cross-automake-v1.15"]

  - name: "gcc"
    subdir: "build"
    git: "https://github.com/gcc-mirror/gcc.git"
    tag: "releases/gcc-11.2.0"
    version: "11.2.0"
    tools_required: ["cross-automake-v1.15"]
    regenerate:
      - args: ["./contrib/download_prerequisites"]
        workdir: "@THIS_SOURCE_DIR@"

  - name: "linux"
    subdir: "build"
    git: "https://github.com/torvalds/linux.git"
    tag: "v5.17"
    version: "5.17"

  - name: "mlibc"
    subdir: "build"
    git: "https://github.com/managarm/mlibc.git"
    branch: "master"
    version: "2.2.0"

  - name: "bash"
    subdir: "build"
    git: "https://git.savannah.gnu.org/git/bash.git"
    branch: "master"
    commit: "15409324f1974d41c183904ad575da7188058c1c"
    version: "5.1.12"
    tools_required: ["cross-automake-v1.15"]
    regenerate:
      - args: ["cp", "@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub", "@THIS_SOURCE_DIR@/support/"]

  - name: "coreutils"
    subdir: "build"
    url: "https://ftp.gnu.org/gnu/coreutils/coreutils-9.0.tar.xz"
    format: "tar.xz"
    extract_path: "coreutils-9.0"
    version: "9.0"
    tools_required: ["cross-automake-v1.15"]
    regenerate:
      - args: ["autoreconf", "-fvi"]

  - name: "python"
    subdir: "build"
    git: "https://github.com/python/cpython.git"
    tag: "v3.8.2"
    version: "3.8.2"
    tools_required: ["cross-automake-v1.15", "cross-libtool", "cross-pkg-config"]
    regenerate:
      - args: ["autoreconf", "-fvi"]

  - name: "libexpat"
    subdir: "build"
    git: "https://github.com/libexpat/libexpat.git"
    tag: "R_2_4_1"
    version: "2.4.1"
    tools_required: ["cross-automake-v1.15", "cross-libtool"]
    regenerate:
      - args: ["./buildconf.sh"]
        workdir: "@THIS_SOURCE_DIR@/expat"

  - name: "libffi"
    subdir: "build"
    git: "https://github.com/libffi/libffi.git"
    tag: "v3.4.2"
    version: "3.4.2"
    tools_required: ["cross-automake-v1.15", "cross-libtool"]
    regenerate:
      - args: ["./autogen.sh"]
      - args: ["cp", "@BUILD_ROOT@/tools/cross-automake-v1.15/share/automake-1.15/config.sub", "@THIS_SOURCE_DIR@/"]

declare_options:
  - name: arch
    default: x86_64
  - name: arch-triple
    default: x86_64-linux-mlibc

tools:
  - name: "cross-autoconf-v2.69"
    from_source: "autoconf-v2.69"
    configure:
      - args: ["@THIS_SOURCE_DIR@/configure", "--prefix=@PREFIX@"]
    compile:
      - args: ["make", "-j", "@PARALLELISM@"]
    install:
      - args: ["make", "install"]

  - name: "cross-automake-v1.15"
    from_source: "automake-v1.15"
    tools_required:
      - tool: "cross-autoconf-v2.69"
        recursive: true
    configure:
      - args: ["@THIS_SOURCE_DIR@/configure", "--prefix=@PREFIX@", "MAKEINFO=/bin/true"]
    compile:
      - args: ["make", "-j", "@PARALLELISM@"]
    install:
      - args: ["make", "install"]
      - args: ["ln", "-sf", "@PREFIX@/share/aclocal-1.15", "@PREFIX@/share/aclocal"]

  - name: "cross-libtool"
    exports_aclocal: true
    from_source: "libtool"
    tools_required: ["cross-automake-v1.15"]
    configure:
      - args: ["@THIS_SOURCE_DIR@/configure", "--prefix=@PREFIX@"]
    compile:
      - args: ["make", "-j", "@PARALLELISM@"]
    install:
      - args: ["make", "install"]

  - name: "cross-pkg-config"
    exports_aclocal: true
    from_source: "pkg-config"
    configure:
      - args: ["@THIS_SOURCE_DIR@/configure", "--prefix=@PREFIX@", "--with-internal-glib"]
    compile:
      - args: ["make", "-j", "@PARALLELISM@"]
    install:
      - args: ["make", "install"]

  - name: "cross-binutils"
    from_source: "binutils"
    tools_required:
      - tool: "cross-automake-v1.15"
        recursive: true
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--prefix=@PREFIX@"
          - "--with-sysroot=@SYSROOT_DIR@"
          - "--target=@OPTION:arch-triple@"
          - "--disable-nls"
          - "--disable-werror"
    compile:
      - args: ["make", "-j", "@PARALLELISM@"]
    install:
      - args: ["make", "install"]

  - name: "cross-gcc"
    from_source: "gcc"
    tools_required:
      - tool: "cross-binutils"
        recursive: true
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--prefix=@PREFIX@"
          - "--with-sysroot=@SYSROOT_DIR@"
          - "--target=@OPTION:arch-triple@"
          - "--enable-languages=c,c++"
          - "--disable-multilib"
          - "--disable-nls"
          - "--enable-initfini-array"
          - "--enable-libstdcxx-filesystem-ts"
    stages:
      - name: "compiler"
        pkgs_required: ["mlibc-headers"]
        compile:
          - args: ["make", "-j", "@PARALLELISM@", "all-gcc"]
        install:
          - args: ["make", "install-gcc"]
          - args: ["mkdir", "-p", "@PREFIX@/@OPTION:arch-triple@/bin"]
          - args: ["ln", "-sf", "../../../cross-binutils/@OPTION:arch-triple@/bin/as", "@PREFIX@/@OPTION:arch-triple@/bin/as"]
          - args: ["ln", "-sf", "../../../cross-binutils/@OPTION:arch-triple@/bin/ld", "@PREFIX@/@OPTION:arch-triple@/bin/ld"]

      - name: "libgcc"
        tools_required:
          - tool: "cross-gcc"
            stage_dependencies: ["compiler"]
        pkgs_required:
          - "mlibc"
        compile:
          - args: ["make", "-j", "@PARALLELISM@", "all-target-libgcc"]
        install:
          - args: ["make", "install-target-libgcc"]

      - name: "libstdc++"
        tools_required:
          - tool: "cross-gcc"
            stage_dependencies: ["libgcc"]
        compile:
          - args: ["make", "-j", "@PARALLELISM@", "all-target-libstdc++-v3"]
        install:
          - args: ["make", "install-strip-target-libstdc++-v3"]

  - name: "cross-python"
    from_source: "python"
    configure:
      - args: ["@THIS_SOURCE_DIR@/configure", "--prefix=@PREFIX@"]
    compile:
      - args: ["make", "-j", "@PARALLELISM@"]
    install:
      - args: ["make", "install"]

packages:
  - name: "base-files"
    source:
      subdir: "meta-sources"
      version: "1.0"
    default: true
    build:
      - args: |
          mkdir -pv @THIS_COLLECT_DIR@/usr/{,local/}{bin,include,lib,sbin,src}

          ln -sfv usr/bin @THIS_COLLECT_DIR@/bin
          ln -sfv usr/lib @THIS_COLLECT_DIR@/lib
          ln -sfv usr/sbin @THIS_COLLECT_DIR@/sbin

          mkdir -pv @THIS_COLLECT_DIR@/{boot,home,mnt,opt,srv}
          mkdir -pv @THIS_COLLECT_DIR@/etc/{opt,sysconfig}
          mkdir -pv @THIS_COLLECT_DIR@/lib/firmware
          mkdir -pv @THIS_COLLECT_DIR@/media/{floppy,cdrom}
          mkdir -pv @THIS_COLLECT_DIR@/usr/local/{bin,lib,sbin}
          mkdir -pv @THIS_COLLECT_DIR@/usr/{,local/}share/{color,dict,doc,info,locale,man}
          mkdir -pv @THIS_COLLECT_DIR@/usr/{,local/}share/{misc,terminfo,zoneinfo}
          mkdir -pv @THIS_COLLECT_DIR@/usr/{,local/}share/man/man{1..8}
          mkdir -pv @THIS_COLLECT_DIR@/var/{cache,local,log,mail,opt,spool}
          mkdir -pv @THIS_COLLECT_DIR@/var/lib/{color,misc,locate}

          install -dv -m 0750 @THIS_COLLECT_DIR@/root
          install -dv -m 1777 @THIS_COLLECT_DIR@/tmp @THIS_COLLECT_DIR@/var/tmp

          cp @THIS_SOURCE_DIR@/{group,hosts,passwd,profile} @THIS_COLLECT_DIR@/etc
          cp @THIS_SOURCE_DIR@/.bashrc @THIS_COLLECT_DIR@/root

          touch @THIS_COLLECT_DIR@/{boot,home,mnt,opt,root,srv,tmp}/.keep
          touch @THIS_COLLECT_DIR@/etc/{opt,sysconfig}/.keep
          touch @THIS_COLLECT_DIR@/lib/firmware/.keep
          touch @THIS_COLLECT_DIR@/media/{floppy,cdrom}/.keep
          touch @THIS_COLLECT_DIR@/usr/{,local/}{bin,include,lib,sbin,src}/.keep
          touch @THIS_COLLECT_DIR@/usr/local/{bin,lib,sbin}/.keep
          touch @THIS_COLLECT_DIR@/usr/{,local/}share/{color,dict,doc,info,locale,man}/.keep
          touch @THIS_COLLECT_DIR@/usr/{,local/}share/{misc,terminfo,zoneinfo}/.keep
          touch @THIS_COLLECT_DIR@/usr/{,local/}share/man/man{1..8}/.keep
          touch @THIS_COLLECT_DIR@/var/{cache,local,log,mail,opt,spool}/.keep
          touch @THIS_COLLECT_DIR@/var/lib/{color,misc,locate}/.keep
          touch @THIS_COLLECT_DIR@/{tmp,var/tmp}/.keep

          ln -sfv run @THIS_COLLECT_DIR@/var/run
          ln -sfv run/lock @THIS_COLLECT_DIR@/var/lock

  - name: "tzdata"
    from_source: "tzdata"
    default: true
    configure:
      - args: ["cp", "-r", "@THIS_SOURCE_DIR@/.", "@THIS_BUILD_DIR@"]
    build:
      # Create the required directories
      - args: ["mkdir", "-p", "@THIS_COLLECT_DIR@/etc"]
      - args: ["mkdir", "-p", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix"]
      - args: ["mkdir", "-p", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right"]
      # Create the time zone files without leap seconds, convention puts these in both zoneinfo and zoneinfo/posix.
      # After that. create time time zone files with leap seconds
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/etcetera"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/etcetera"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/etcetera"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/southamerica"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/southamerica"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/southamerica"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/northamerica"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/northamerica"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/northamerica"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/europe"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/europe"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/europe"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/africa"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/africa"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/africa"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/antarctica"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/antarctica"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/antarctica"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/asia"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/asia"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/asia"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/australasia"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/australasia"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/australasia"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "@THIS_BUILD_DIR@/backward"]
      - args: ["/usr/sbin/zic", "-L", "/dev/null", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/posix", "@THIS_BUILD_DIR@/backward"]
      - args: ["/usr/sbin/zic", "-L", "@THIS_SOURCE_DIR@/leapseconds", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo/right", "@THIS_BUILD_DIR@/backward"]
      # Copy some needed files to their location
      - args: ["cp", "@THIS_BUILD_DIR@/zone.tab", "@THIS_BUILD_DIR@/zone1970.tab", "@THIS_BUILD_DIR@/iso3166.tab", "@THIS_COLLECT_DIR@/usr/share/zoneinfo"]
      # Create the posixrules file, POSIX requires daylight saving rules to be in accordance with US rules, thus use New York
      - args: ["/usr/sbin/zic", "-d", "@THIS_COLLECT_DIR@/usr/share/zoneinfo", "-p", "America/New_York"]
      # Default to UTC for localtime, this should be fixed, but that is pending xbstrap support.
      - args: ["ln", "-sf", "/usr/share/zoneinfo/UTC", "@THIS_COLLECT_DIR@/etc/localtime"]

  - name: "kernel-headers"
    from_source: "linux"
    implict_package: true
    configure:
      - args: ["rsync", "-ar", "@THIS_SOURCE_DIR@/", "@THIS_BUILD_DIR@/"]
    build:
      - args: ["make", "headers"]
      - args: ["find", "usr/include", "-name", '".*"', "-delete"]
      - args: ["rm", "usr/include/Makefile"]
      - args: ["mkdir", "-pv", "@THIS_COLLECT_DIR@/usr"]
      - args: ["cp", "-rv", "usr/include", "@THIS_COLLECT_DIR@/usr"]

  # TODO: Build the kernel itself too

  - name: "mlibc-headers"
    from_source: "mlibc"
    implict_package: true
    pkgs_required: ["kernel-headers"]
    configure:
      - args:
          - "meson"
          - "--cross-file"
          - "@SOURCE_ROOT@/cross.ini"
          - "--prefix=/usr"
          - "-Dheaders_only=true"
          - "-Ddisable_iconv_option=true"
          - "-Dbuildtype=debug"
          - "@THIS_SOURCE_DIR@"
    build:
      - args: ["ninja"]
      - args: ["ninja", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"

  - name: "mlibc"
    from_source: "mlibc"
    tools_required:
      - tool: "cross-gcc"
        stage_dependencies: ["compiler"]
    implict_package: true
    pkgs_required: ["mlibc-headers"]
    configure:
      - args:
          - "meson"
          - "--cross-file"
          - "@SOURCE_ROOT@/cross.ini"
          - "--prefix=/usr"
          - "--libdir=lib"
          - "-Dmlibc_no_headers=true"
          - "-Ddisable_iconv_option=true"
          - "-Dbuildtype=debug"
          - "@THIS_SOURCE_DIR@"
    build:
      - args: ["ninja"]
      - args: ["ninja", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"

  - name: "bash"
    from_source: "bash"
    tools_required: ["cross-gcc"]
    pkgs_required: ["mlibc"]
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--host=@OPTION:arch-triple@"
          - "--prefix=/usr"
          - "--without-bash-malloc"
          - "--disable-nls"
    build:
      - args: ["make", "-j", "@PARALLELISM@"]
      - args: ["make", "DESTDIR=@THIS_COLLECT_DIR@", "install"]

  - name: "coreutils"
    from_source: "coreutils"
    tools_required: ["cross-gcc"]
    pkgs_required: ["mlibc"]
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--host=@OPTION:arch-triple@"
          - "--prefix=/usr"
          - "--enable-install-program=hostname"
          - "--enable-no-install-program=kill,uptime"
          - "CFLAGS=-DSLOW_BUT_NO_HACKS"
    build:
      - args: ["make", "-j", "@PARALLELISM@"]
      - args: ["make", "DESTDIR=@THIS_COLLECT_DIR@", "install"]

  - name: "python"
    from_source: "python"
    tools_required: ["cross-gcc", "cross-pkg-config", "cross-python"]
    pkgs_required: ["mlibc", "libexpat", "libffi"]
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--host=@OPTION:arch-triple@"
          - "--build=x86_64-linux-gnu"
          - "--prefix=/usr"
          - "--enable-shared"
          - "--with-sysroot=@SYSROOT_DIR@" # Set libtool's lt_sysroot.
          - "--with-system-ffi"
          - "--with-system-expat"
          - "--disable-ipv6"
        environ:
          CONFIG_SITE: "@SOURCE_ROOT@/misc/python-config-site"
          PKG_CONFIG_SYSROOT_DIR: "@BUILD_ROOT@/system-root"
          PKG_CONFIG_LIBDIR: "@BUILD_ROOT@/system-root/usr/lib/pkgconfig:@BUILD_ROOT@/system-root/usr/share/pkgconfig"
    build:
      - args: ["make", "-j", "@PARALLELISM@"]
      - args: ["make", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"

  - name: "libexpat"
    from_source: "libexpat"
    tools_required: ["cross-automake-v1.15", "cross-libtool", "cross-gcc"]
    pkgs_required: ["mlibc"]
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/expat/configure"
          - "--host=@OPTION:arch-triple@"
          - "--prefix=/usr"
          - "--with-sysroot=@SYSROOT_DIR@" # Set libtool's lt_sysroot.
          - "--without-xmlwf"
    build:
      - args: ["make", "-j", "@PARALLELISM@"]
      - args: ["make", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"

  - name: "libffi"
    from_source: "libffi"
    tools_required: ["cross-gcc"]
    pkgs_required: ["mlibc"]
    configure:
      - args:
          - "@THIS_SOURCE_DIR@/configure"
          - "--host=@OPTION:arch-triple@"
          - "--prefix=/usr"
          - "--with-sysroot=@SYSROOT_DIR@" # Set libtool's lt_sysroot.
    build:
      - args: ["make", "-j", "@PARALLELISM@"]
      - args: ["make", "install"]
        environ:
          DESTDIR: "@THIS_COLLECT_DIR@"
